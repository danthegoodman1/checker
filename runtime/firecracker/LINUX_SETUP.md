# Firecracker Setup on Linux

Firecracker is a virtual machine monitor (VMM) that uses KVM to create and manage microVMs. It requires a Linux host with KVM enabled.

## Prerequisites

### 1. Hardware Requirements

- x86_64 or aarch64 processor with virtualization support
- KVM enabled (check with `ls /dev/kvm`)

### 2. Install Firecracker

```bash
# Download latest Firecracker release
ARCH=$(uname -m)
FC_VERSION="v1.13.1"
curl -fL "https://github.com/firecracker-microvm/firecracker/releases/download/${FC_VERSION}/firecracker-${FC_VERSION}-${ARCH}.tgz" \
  | tar -xz

# Install to PATH
sudo mv release-${FC_VERSION}-${ARCH}/firecracker-${FC_VERSION}-${ARCH} /usr/local/bin/firecracker
sudo chmod +x /usr/local/bin/firecracker

# Verify installation
firecracker --version
```

### 3. Download Kernel

Firecracker requires an uncompressed Linux kernel:

```bash
# Download pre-built kernel (recommended)
curl -fLo vmlinux-5.10.bin "https://s3.amazonaws.com/spec.ccfc.min/firecracker-ci/v1.10/x86_64/vmlinux-5.10.223"

# Make it accessible (e.g., /opt/firecracker/)
sudo mkdir -p /opt/firecracker
sudo mv vmlinux-5.10.bin /opt/firecracker/
```

### 4. Install Required Tools for Rootfs Building

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y buildah skopeo umoci e2fsprogs iproute2 jq

# Fedora/RHEL
sudo dnf install -y buildah skopeo umoci e2fsprogs iproute jq
```

### 5. KVM Permissions

Firecracker needs access to `/dev/kvm`:

```bash
# Add your user to the kvm group
sudo usermod -aG kvm $USER

# Or set permissions on /dev/kvm
sudo chmod 666 /dev/kvm

# Verify access
ls -la /dev/kvm
```

## Network Setup (IPv6)

Firecracker VMs use TAP devices attached to a host bridge for networking. This setup uses IPv6-only networking with addresses automatically derived from execution IDs, providing virtually unlimited unique addresses.

### Network Architecture

- **Bridge IP**: `fdfc::1` (gateway for all VMs)
- **Guest IPs**: `fdfc:<execution_id>` (auto-derived, unique per VM)
- **Prefix**: `fdfc::/16` (~2^112 addresses)

### 1. Create Network Bridge (One-Time Setup)

```bash
# Create bridge with IPv6
sudo ip link add fcbr0 type bridge
sudo ip link set fcbr0 up

# Disable DAD (Duplicate Address Detection) to avoid "tentative" address state
# This is needed because the bridge has no carrier until a TAP device is attached
sudo sysctl -w net.ipv6.conf.fcbr0.accept_dad=0
sudo sysctl -w net.ipv6.conf.fcbr0.dad_transmits=0

# Add IPv6 address
sudo ip -6 addr add fdfc::1/16 dev fcbr0

# Enable IPv6 forwarding
echo 1 | sudo tee /proc/sys/net/ipv6/conf/all/forwarding

# Make settings persistent (add to /etc/sysctl.conf)
cat << 'EOF' | sudo tee -a /etc/sysctl.conf
net.ipv6.conf.all.forwarding = 1
net.ipv6.conf.fcbr0.accept_dad = 0
net.ipv6.conf.fcbr0.dad_transmits = 0
EOF
```

### 2. Configure NAT for Internet Access

```bash
# Enable masquerading for the Firecracker network (IPv6)
sudo ip6tables -t nat -A POSTROUTING -s fdfc::/16 ! -o fcbr0 -j MASQUERADE

# Allow forwarding to/from the bridge
sudo ip6tables -A FORWARD -i fcbr0 -j ACCEPT
sudo ip6tables -A FORWARD -o fcbr0 -m state --state RELATED,ESTABLISHED -j ACCEPT
```

To make ip6tables rules persistent:

```bash
# Ubuntu/Debian
sudo apt-get install -y iptables-persistent
sudo netfilter-persistent save

# Fedora/RHEL
sudo dnf install -y iptables-services
sudo service ip6tables save
```

### 3. Verify Network Setup

```bash
# Check bridge exists
ip link show fcbr0

# Check IPv6 address
ip -6 addr show fcbr0

# Check ip6tables rules
sudo ip6tables -t nat -L POSTROUTING -n -v
sudo ip6tables -L FORWARD -n -v
```

## Building Rootfs from Docker Images

Use the `scripts/build-fc-rootfs.sh` script to convert Docker images to Firecracker-compatible ext4 rootfs:

```bash
# Build rootfs from a Dockerfile
./scripts/build-fc-rootfs.sh demo/Dockerfile.checkpoint_restore /path/to/output.ext4

# The script:
# 1. Builds the Docker image using buildah
# 2. Extracts the image to an OCI bundle
# 3. Creates an /init script that configures IPv6 networking from env vars
# 4. Packages everything into an ext4 filesystem
```

### Rootfs Requirements

The rootfs must have an `/init` script that:
1. Mounts essential filesystems (proc, sys, dev)
2. Sources `/etc/checker.env` for runtime configuration
3. Configures IPv6 networking from `CHECKER_GUEST_IP` and `CHECKER_GATEWAY`
4. Runs the container's entrypoint

Example `/init` script (generated by build-fc-rootfs.sh):

```bash
#!/bin/sh
# Mount essential filesystems
mount -t proc proc /proc
mount -t sysfs sys /sys
mount -t devtmpfs dev /dev 2>/dev/null || true

# Set up PATH
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# Source runtime-injected environment variables
# Includes: CHECKER_GUEST_IP, CHECKER_GATEWAY, CHECKER_API_URL, CHECKER_JOB_ID
if [ -f /etc/checker.env ]; then
    . /etc/checker.env
fi

# Configure IPv6 networking
if [ -n "$CHECKER_GUEST_IP" ] && [ -n "$CHECKER_GATEWAY" ]; then
    ip link set eth0 up
    ip -6 addr add "$CHECKER_GUEST_IP" dev eth0
    ip -6 route add default via "$CHECKER_GATEWAY"
    echo "nameserver 2001:4860:4860::8888" > /etc/resolv.conf
fi

# Run the container's entrypoint
cd /app
exec node checkpoint_restore_worker.js

# Shutdown on exit
reboot -f
```

## Configuration

### NetworkConfig Fields

| Field | Required | Description | Example |
|-------|----------|-------------|---------|
| `bridge_name` | Yes | Host bridge to attach TAP device | `"fcbr0"` |
| `guest_mac` | No | MAC address (auto-generated if empty) | `"AA:BB:CC:DD:EE:FF"` |

Note: `guest_ip` and `guest_gateway` are automatically derived from the execution ID at runtime.

### Example Config

```json
{
    "kernel_path": "/opt/firecracker/vmlinux-5.10.bin",
    "rootfs_path": "/path/to/rootfs.ext4",
    "vcpu_count": 2,
    "mem_size_mib": 512,
    "network": {
        "bridge_name": "fcbr0"
    }
}
```

### Runtime-Injected Environment Variables

The following environment variables are injected into `/etc/checker.env` at runtime:

| Variable | Description | Example |
|----------|-------------|---------|
| `CHECKER_API_URL` | Hypervisor API URL | `http://[fdfc::1]:8080` |
| `CHECKER_JOB_ID` | Job/Execution ID | `job-1234567890-1` |
| `CHECKER_GUEST_IP` | Guest IPv6 with CIDR (derived from job ID hash) | `fdfc:a1b2:c3d4:e5f6:7890:abcd:ef01:2345/16` |
| `CHECKER_GATEWAY` | Gateway IPv6 | `fdfc::1` |

## Running Tests

```bash
# Set kernel path
export FC_KERNEL_PATH=/opt/firecracker/vmlinux-5.10.bin

# Run Firecracker tests
go test -v -run TestFirecracker ./...

# Run with network bridge configured
# (requires fcbr0 bridge to be set up with IPv6)
go test -v -run TestFirecrackerNetwork ./...
```

## Troubleshooting

### "firecracker not found"

Ensure firecracker is in your PATH:

```bash
which firecracker
# If not found, add to PATH or install
```

### "Cannot open /dev/kvm"

Check KVM permissions:

```bash
ls -la /dev/kvm
# Should be readable/writable by your user or kvm group
```

### Network not working in VM

1. Verify bridge exists: `ip link show fcbr0`
2. Verify bridge has IPv6: `ip -6 addr show fcbr0`
3. Verify TAP device is created: `ip link show tap-*`
4. Check TAP is attached to bridge: `bridge link show`
5. Verify IPv6 forwarding: `cat /proc/sys/net/ipv6/conf/all/forwarding` (should be 1)
6. Check ip6tables NAT rules: `sudo ip6tables -t nat -L -n -v`

### VM starts but no network connectivity

The guest `/init` script must configure networking. Check that:
1. `/etc/checker.env` is sourced before network setup
2. `CHECKER_GUEST_IP` and `CHECKER_GATEWAY` are set
3. `ip -6 addr add` and `ip -6 route add` are using these variables
4. DNS is configured (`/etc/resolv.conf`)

### Snapshot restore fails with network

When restoring from snapshot with networking:
1. The TAP device is recreated with the same name
2. The guest network config is preserved in the snapshot (no reconfiguration needed)
3. The guest wakes up with its IPv6 already configured

## Security Considerations

- Firecracker VMs run with reduced privileges using seccomp and namespace isolation
- TAP devices require root or CAP_NET_ADMIN capability to create
- Consider using a dedicated network namespace for additional isolation
- The host bridge exposes the hypervisor API to VMs - ensure proper authentication
- IPv6 ULA addresses (fdfc::/16) are not globally routable

## References

- [Firecracker Documentation](https://github.com/firecracker-microvm/firecracker/tree/main/docs)
- [Firecracker Network Setup](https://github.com/firecracker-microvm/firecracker/blob/main/docs/network-setup.md)
- [Firecracker Snapshotting](https://github.com/firecracker-microvm/firecracker/blob/main/docs/snapshotting/snapshot-support.md)
