# Firecracker Setup on Linux

Firecracker is a virtual machine monitor (VMM) that uses KVM to create and manage microVMs. It requires a Linux host with KVM enabled.

## Prerequisites

### 1. Hardware Requirements

- x86_64 or aarch64 processor with virtualization support
- KVM enabled (check with `ls /dev/kvm`)

### 2. Install Firecracker

```bash
# Download latest Firecracker release
ARCH=$(uname -m)
FC_VERSION="v1.10.0"
curl -fLo firecracker "https://github.com/firecracker-microvm/firecracker/releases/download/${FC_VERSION}/firecracker-${FC_VERSION}-${ARCH}.tgz" \
  | tar -xz

# Install to PATH
sudo mv release-${FC_VERSION}-${ARCH}/firecracker-${FC_VERSION}-${ARCH} /usr/local/bin/firecracker
sudo chmod +x /usr/local/bin/firecracker

# Verify installation
firecracker --version
```

### 3. Download Kernel

Firecracker requires an uncompressed Linux kernel:

```bash
# Download pre-built kernel (recommended)
curl -fLo vmlinux-5.10.bin "https://s3.amazonaws.com/spec.ccfc.min/firecracker-ci/v1.10/x86_64/vmlinux-5.10.223"

# Make it accessible (e.g., /opt/firecracker/)
sudo mkdir -p /opt/firecracker
sudo mv vmlinux-5.10.bin /opt/firecracker/
```

### 4. Install Required Tools for Rootfs Building

```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y buildah skopeo umoci e2fsprogs iproute2 jq

# Fedora/RHEL
sudo dnf install -y buildah skopeo umoci e2fsprogs iproute jq
```

### 5. KVM Permissions

Firecracker needs access to `/dev/kvm`:

```bash
# Add your user to the kvm group
sudo usermod -aG kvm $USER

# Or set permissions on /dev/kvm
sudo chmod 666 /dev/kvm

# Verify access
ls -la /dev/kvm
```

## Network Setup

Firecracker VMs use TAP devices attached to a host bridge for networking. This setup enables:
- VM-to-host communication (for the hypervisor API)
- Internet access (via NAT)

### 1. Create Network Bridge (One-Time Setup)

```bash
# Create bridge
sudo ip link add fcbr0 type bridge
sudo ip addr add 172.16.0.1/24 dev fcbr0
sudo ip link set fcbr0 up

# Enable IP forwarding
echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward

# Make IP forwarding persistent (add to /etc/sysctl.conf)
echo "net.ipv4.ip_forward = 1" | sudo tee -a /etc/sysctl.conf
```

### 2. Configure NAT for Internet Access

```bash
# Enable masquerading for the Firecracker network
sudo iptables -t nat -A POSTROUTING -s 172.16.0.0/24 ! -o fcbr0 -j MASQUERADE

# Allow forwarding to/from the bridge
sudo iptables -A FORWARD -i fcbr0 -j ACCEPT
sudo iptables -A FORWARD -o fcbr0 -m state --state RELATED,ESTABLISHED -j ACCEPT
```

To make iptables rules persistent:

```bash
# Ubuntu/Debian
sudo apt-get install -y iptables-persistent
sudo netfilter-persistent save

# Fedora/RHEL
sudo dnf install -y iptables-services
sudo service iptables save
```

### 3. Verify Network Setup

```bash
# Check bridge exists
ip link show fcbr0

# Check IP address
ip addr show fcbr0

# Check iptables rules
sudo iptables -t nat -L POSTROUTING -n -v
sudo iptables -L FORWARD -n -v
```

## Building Rootfs from Docker Images

Use the `scripts/build-fc-rootfs.sh` script to convert Docker images to Firecracker-compatible ext4 rootfs:

```bash
# Build rootfs from a Dockerfile
./scripts/build-fc-rootfs.sh demo/Dockerfile.checkpoint_restore /path/to/output.ext4

# The script:
# 1. Builds the Docker image using buildah
# 2. Extracts the image to an OCI bundle
# 3. Creates an /init script that sets up networking and runs the entrypoint
# 4. Packages everything into an ext4 filesystem
```

### Rootfs Requirements

The rootfs must have an `/init` script that:
1. Mounts essential filesystems (proc, sys, dev)
2. Configures networking (if network config is provided)
3. Runs the container's entrypoint

Example `/init` script (generated by build-fc-rootfs.sh):

```bash
#!/bin/sh
# Mount essential filesystems
mount -t proc proc /proc
mount -t sysfs sys /sys
mount -t devtmpfs dev /dev 2>/dev/null || true

# Set up PATH
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# Configure networking (if eth0 exists)
if ip link show eth0 &>/dev/null; then
    ip link set eth0 up
    ip addr add 172.16.0.2/24 dev eth0
    ip route add default via 172.16.0.1
    echo "nameserver 8.8.8.8" > /etc/resolv.conf
fi

# Run the container's entrypoint
cd /app
exec node checkpoint_restore_worker.js

# Shutdown on exit
reboot -f
```

## Configuration

### NetworkConfig Fields

| Field | Required | Description | Example |
|-------|----------|-------------|---------|
| `bridge_name` | Yes | Host bridge to attach TAP device | `"fcbr0"` |
| `guest_ip` | Yes | IP address for guest (CIDR notation) | `"172.16.0.2/24"` |
| `guest_gateway` | Yes | Default gateway for guest | `"172.16.0.1"` |
| `guest_mac` | No | MAC address (auto-generated if empty) | `"AA:BB:CC:DD:EE:FF"` |

### Example Config

```json
{
    "kernel_path": "/opt/firecracker/vmlinux-5.10.bin",
    "rootfs_path": "/path/to/rootfs.ext4",
    "vcpu_count": 2,
    "mem_size_mib": 512,
    "network": {
        "bridge_name": "fcbr0",
        "guest_ip": "172.16.0.2/24",
        "guest_gateway": "172.16.0.1"
    }
}
```

## Running Tests

```bash
# Set kernel path
export FC_KERNEL_PATH=/opt/firecracker/vmlinux-5.10.bin

# Run Firecracker tests
go test -v -run TestFirecracker ./...

# Run with network bridge configured
# (requires fcbr0 bridge to be set up)
go test -v -run TestFirecrackerNetwork ./...
```

## Troubleshooting

### "firecracker not found"

Ensure firecracker is in your PATH:

```bash
which firecracker
# If not found, add to PATH or install
```

### "Cannot open /dev/kvm"

Check KVM permissions:

```bash
ls -la /dev/kvm
# Should be readable/writable by your user or kvm group
```

### Network not working in VM

1. Verify bridge exists: `ip link show fcbr0`
2. Verify TAP device is created: `ip link show tap-*`
3. Check TAP is attached to bridge: `bridge link show`
4. Verify IP forwarding: `cat /proc/sys/net/ipv4/ip_forward` (should be 1)
5. Check iptables NAT rules: `sudo iptables -t nat -L -n -v`

### VM starts but no network connectivity

The guest `/init` script must configure networking. Check that:
1. `ip link set eth0 up` is called
2. `ip addr add <guest_ip> dev eth0` matches the config
3. `ip route add default via <gateway>` is set
4. DNS is configured (`/etc/resolv.conf`)

### Snapshot restore fails with network

When restoring from snapshot with networking:
1. The TAP device is recreated with the same name
2. The `net_backend` config maps the guest interface to the new TAP
3. The guest network config is preserved in the snapshot (no reconfiguration needed)

## Security Considerations

- Firecracker VMs run with reduced privileges using seccomp and namespace isolation
- TAP devices require root or CAP_NET_ADMIN capability to create
- Consider using a dedicated network namespace for additional isolation
- The host bridge exposes the hypervisor API to VMs - ensure proper authentication

## References

- [Firecracker Documentation](https://github.com/firecracker-microvm/firecracker/tree/main/docs)
- [Firecracker Network Setup](https://github.com/firecracker-microvm/firecracker/blob/main/docs/network-setup.md)
- [Firecracker Snapshotting](https://github.com/firecracker-microvm/firecracker/blob/main/docs/snapshotting/snapshot-support.md)
